<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AFHBA404: ACQPROC-README</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AFHBA404
   </div>
   <div id="projectbrief">AFHBA404 connects ACQ2106 to PCI-Express</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.18 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">ACQPROC-README </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md1"></a>
ACQPROC:</h1>
<ul>
<li>a single compile-once executable supports any 4 UUT's (ACQ2106), any payload.</li>
<li>the system is defined by a config file (json), and the system autoconfigures itself.</li>
<li>we're using a SHM to gather all <a class="el" href="classIO.html" title="Base Class.">IO</a> data from the UUT's in a single AI,DI,AO,DO vectors, it's assumed that the PCS is another process on other cores that interacts with the SHM.</li>
<li>acqproc outputs the aggregate configuration as a config file (json), this publishes indices into shared memory vectors that we expect would be useful for the PCS and offsets of salient fields in the individual <a class="el" href="structVI.html" title="Models Vector Input.">VI</a>, <a class="el" href="structVO.html" title="Models Vector Output.">VO</a> vectors of each UUT, used by our post-shot analysis tools - the goal is that post-shot analysis is automatic, rather than depending on large numbers of command line constants.</li>
<li>logic to handle special cases - eg<ul>
<li>BOLO8 (data not in phase),</li>
<li>WATCHDOG (a pulse output before trigger).</li>
</ul>
</li>
<li>For a NEW PCS:<ul>
<li>Define the config file</li>
<li>Subclass the shared memory interface <a class="el" href="structSystemInterface.html" title="Models interface with external PCS.">SystemInterface</a> to connect to your system. <div class="fragment"><div class="line"> {C++}</div>
<div class="line">struct SystemInterface {</div>
<div class="line"> </div>
<div class="line">public:</div>
<div class="line">    /** ONE vector each type, all VI from all UUTS are split into types and</div>
<div class="line">     *   aggregated in the appropriate vectors. </div>
<div class="line">     */</div>
<div class="line">    struct Inputs {</div>
<div class="line">        short *AI16;</div>
<div class="line">        int *AI32;</div>
<div class="line">        unsigned *DI32;</div>
<div class="line">        unsigned *SP32;</div>
<div class="line">    } IN;</div>
<div class="line">    /**&lt; ONE vector each type, scatter each type to appropriate VO all UUTS  */</div>
<div class="line">    struct Outputs {</div>
<div class="line">        short* AO16;</div>
<div class="line">        unsigned *DO32;</div>
<div class="line">        unsigned *CC32;         /* calc values from PCS .. NOT outputs. */</div>
<div class="line">    } OUT;</div>
<div class="line"> </div>
<div class="line">    SystemInterface(const HBA&amp; _hba);</div>
<div class="line"> </div>
<div class="line">    virtual void ringDoorbell(int sample)</div>
<div class="line">    /**&lt; alert PCS that there is new data .. implement by subclass. */</div>
</div><!-- fragment --></li>
<li>In a Single Thread implementation:<ul>
<li>Inputs, Outputs are created from simple heap allocations</li>
<li>method ringDoorbell() is called when there is new data.</li>
<li>Single Thread implementations can perform <a class="el" href="classIO.html" title="Base Class.">IO</a> processing inside ringDoorbell(), leaving updated Outputs for the system to handle.</li>
<li>examples <a href="https://github.com/D-TACQ/AFHBA404/blob/master/ACQPROC/DefaultSystemInterface.cpp">https://github.com/D-TACQ/AFHBA404/blob/master/ACQPROC/DefaultSystemInterface.cpp</a></li>
<li>a "real" case will be more complex, and it may be an interface to another framework<ul>
<li>eg the Subclass could be a SIMULINK wrapper.</li>
</ul>
</li>
</ul>
</li>
<li>In a Multi Thread implementation:<ul>
<li>a subclass of <a class="el" href="structSystemInterface.html" title="Models interface with external PCS.">SystemInterface</a> could place Inputs Outputs in Shared Memory SHM</li>
<li>method ringDoorbell() is called when there is new data.</li>
<li>in a Multi Thread implementation, ringDoorBell() implements an IPC signal to the main task running in another thread of control, probably on other core[s]</li>
<li>so far, we didn't provide a Multi Thread example.</li>
</ul>
</li>
<li>Late Binding:<ul>
<li>different implementations of <a class="el" href="structSystemInterface.html" title="Models interface with external PCS.">SystemInterface</a> are combined at link time.</li>
<li>See Makefile for explicit examples</li>
<li>New implementations should probably extend the Makefile. Or, we could provide acqproc as a solib.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md2"></a>
Glossary:</h1>
<ul>
<li>PCS: Plasma Control System</li>
<li>SHM: Shared Memory</li>
<li>UUT: Unit Under Test, in our case, an ACQ2106 DAQ Appliance with variable module payload.</li>
<li>AFHBA404: Host Bus Adapter with 4 fiber link ports, supporting up to 4UUT's.</li>
<li>acqproc: compile once, configuration driven data handling engine supporting 4UUT's as the <a class="el" href="classIO.html" title="Base Class.">IO</a> processor for a PCS</li>
</ul>
<h2><a class="anchor" id="autotoc_md3"></a>
Vectors</h2>
<ul>
<li><a class="el" href="structVI.html" title="Models Vector Input.">VI</a> : Vector Input: UUT sends a sample every clock, this is the <a class="el" href="structVI.html" title="Models Vector Input.">VI</a>, comprised of AI16, AI32, DI32, SP32</li>
<li><a class="el" href="structVO.html" title="Models Vector Output.">VO</a> : Vector Output: UUT fetches an output sample every clock, this is the <a class="el" href="structVO.html" title="Models Vector Output.">VO</a>, comprising AO16, DO32, CP32</li>
</ul>
<h2><a class="anchor" id="autotoc_md4"></a>
Fields in Vectors</h2>
<ul>
<li>AI16 : Analog Input, 16 bit.(eg ACQ424ELF-32)</li>
<li>AI32 : Analog Input, 32 bit (eg BOLO8)</li>
<li>DI32 : Digital Input, 32 bit (eg DIO432ELF)</li>
<li>SP32 : Scratch Pad, 32 bit unsigned. SPAD[0] is the TLATCH or sample count.</li>
<li>AO16 : Analog Output, 16 bit, (eg AO424ELF-32)</li>
<li>DO32 : Digital Output, 32 bit, (eg DI423ELF)</li>
<li>CP32 : Calc Value, 32 bit, an intermediate calc result from the PCS. This is NOT sent to the UUT, but is stored in the raw output.</li>
</ul>
<h1><a class="anchor" id="autotoc_md5"></a>
sample config file, pcs1.json</h1>
<div class="fragment"><div class="line">{</div>
<div class="line">    &quot;AFHBA&quot;: {</div>
<div class="line">        &quot;UUT&quot;: [</div>
<div class="line">...</div>
<div class="line">            {   &quot;name&quot; : &quot;acq2106_555&quot;,  </div>
<div class="line">            &quot;type&quot;: &quot;bolo&quot;,</div>
<div class="line">                    &quot;VI&quot; : {</div>
<div class="line">                        &quot;AI32&quot; : 48,  </div>
<div class="line">                &quot;SP32&quot; : 16</div>
<div class="line">                         }</div>
<div class="line">                }</div>
<div class="line">        ]</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md6"></a>
Typical Dummy Run:</h1>
<div class="fragment"><div class="line">[pgm@hoy5 AFHBA404]$ sudo ./ACQPROC/acqproc ./ACQPROC/configs/pcs1.json </div>
<div class="line">NOTICE: port 3 is bolo in non-bolo set, set nowait</div>
<div class="line">HBA0 VI:1216 VO:204</div>
<div class="line">    [0] acq2106_123 VI:320 VO:68 Offset of SPAD IN VI :260</div>
<div class="line"> System Interface Indices 0,0 WD mask: 0x80000000</div>
<div class="line">    [1] acq2106_124 VI:320 VO:68 Offset of SPAD IN VI :260</div>
<div class="line"> System Interface Indices 128,15</div>
<div class="line">    [2] acq2106_125 VI:320 VO:68 Offset of SPAD IN VI :260</div>
<div class="line"> System Interface Indices 256,30</div>
<div class="line">    [3] acq2106_555 VI:256 VO:0 Offset of SPAD IN VI :192</div>
<div class="line"> System Interface Indices 384,45</div>
<div class="line"> new sample: 0 acq2106_123</div>
<div class="line"> new sample: 0 acq2106_124</div>
<div class="line"> new sample: 0 acq2106_125</div>
<div class="line"> new sample: 0 acq2106_555</div>
<div class="line"> new sample: 1 acq2106_123</div>
<div class="line"> new sample: 1 acq2106_124</div>
<div class="line"> new sample: 1 acq2106_125</div>
<div class="line"> new sample: 1 acq2106_555</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md7"></a>
runtime.json : computed system configuration</h1>
<h2><a class="anchor" id="autotoc_md8"></a>
AFHBA</h2>
<p>First, a reflection of the original config file: </p><div class="fragment"><div class="line">{</div>
<div class="line">    &quot;AFHBA&quot;: {</div>
<div class="line">        &quot;UUT&quot;: [</div>
<div class="line">            {</div>
<div class="line">                &quot;VI&quot;: {</div>
<div class="line">                    &quot;AI16&quot;: 128,</div>
<div class="line">                    &quot;DI32&quot;: 1,</div>
<div class="line">                    &quot;SP32&quot;: 15</div>
<div class="line">                },</div>
<div class="line">                &quot;VO&quot;: {</div>
<div class="line">                    &quot;AO16&quot;: 32,</div>
<div class="line">                    &quot;DO32&quot;: 1</div>
<div class="line">                },</div>
<div class="line">                &quot;WD_BIT&quot;: 31,</div>
<div class="line">                &quot;name&quot;: &quot;acq2106_123&quot;,</div>
<div class="line">                &quot;type&quot;: &quot;pcs&quot;</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;VI&quot;: {</div>
<div class="line">                    &quot;AI16&quot;: 128,</div>
<div class="line">                    &quot;DI32&quot;: 1,</div>
<div class="line">                    &quot;SP32&quot;: 15</div>
<div class="line">                },</div>
<div class="line">                &quot;VO&quot;: {</div>
<div class="line">                    &quot;AO16&quot;: 32,</div>
<div class="line">                    &quot;DO32&quot;: 1</div>
<div class="line">                },</div>
<div class="line">                &quot;name&quot;: &quot;acq2106_124&quot;,</div>
<div class="line">                &quot;type&quot;: &quot;pcs&quot;</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;VI&quot;: {</div>
<div class="line">                    &quot;AI16&quot;: 128,</div>
<div class="line">                    &quot;DI32&quot;: 1,</div>
<div class="line">                    &quot;SP32&quot;: 15</div>
<div class="line">                },</div>
<div class="line">                &quot;VO&quot;: {</div>
<div class="line">                    &quot;AO16&quot;: 32,</div>
<div class="line">                    &quot;DO32&quot;: 1</div>
<div class="line">                },</div>
<div class="line">                &quot;name&quot;: &quot;acq2106_125&quot;,</div>
<div class="line">                &quot;type&quot;: &quot;pcs&quot;</div>
<div class="line">            },</div>
<div class="line">            {</div>
<div class="line">                &quot;VI&quot;: {</div>
<div class="line">                    &quot;AI32&quot;: 48,</div>
<div class="line">                    &quot;SP32&quot;: 16</div>
<div class="line">                },</div>
<div class="line">                &quot;name&quot;: &quot;acq2106_555&quot;,</div>
<div class="line">                &quot;type&quot;: &quot;bolo&quot;</div>
<div class="line">            }</div>
<div class="line">        ]</div>
<div class="line">    },</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md9"></a>
GLOBAL_INDICES</h2>
<p>Then, a configuration structure with GLOBAL_INDICES, indices into the type-specific SHM vectors </p><div class="fragment"><div class="line">&quot;SYS&quot;: {</div>
<div class="line">     &quot;UUT&quot;: {</div>
<div class="line">         &quot;GLOBAL_INDICES&quot;: [</div>
<div class="line">             {</div>
<div class="line">                 &quot;VI&quot;: {</div>
<div class="line">                     &quot;AI16&quot;: 0,</div>
<div class="line">                     &quot;DI32&quot;: 0,</div>
<div class="line">                     &quot;SP32&quot;: 0</div>
<div class="line">                 },</div>
<div class="line">                 &quot;VO&quot;: {</div>
<div class="line">                     &quot;AO16&quot;: 0,</div>
<div class="line">                     &quot;DO32&quot;: 0</div>
<div class="line">                 }</div>
<div class="line">             },</div>
<div class="line">             {</div>
<div class="line">                 &quot;VI&quot;: {</div>
<div class="line">                     &quot;AI16&quot;: 128,</div>
<div class="line">                     &quot;DI32&quot;: 1,</div>
<div class="line">                     &quot;SP32&quot;: 15</div>
<div class="line">                 },</div>
<div class="line">                 &quot;VO&quot;: {</div>
<div class="line">                     &quot;AO16&quot;: 32,</div>
<div class="line">                     &quot;DO32&quot;: 1</div>
<div class="line">                 }</div>
<div class="line">             },</div>
<div class="line">             {</div>
<div class="line">                 &quot;VI&quot;: {</div>
<div class="line">                     &quot;AI16&quot;: 256,</div>
<div class="line">                     &quot;DI32&quot;: 2,</div>
<div class="line">                     &quot;SP32&quot;: 30</div>
<div class="line">                 },</div>
<div class="line">                 &quot;VO&quot;: {</div>
<div class="line">                     &quot;AO16&quot;: 64,</div>
<div class="line">                     &quot;DO32&quot;: 2</div>
<div class="line">                 }</div>
<div class="line">             },</div>
<div class="line">             {</div>
<div class="line">                 &quot;VI&quot;: {</div>
<div class="line">                     &quot;AI32&quot;: 0,</div>
<div class="line">                     &quot;SP32&quot;: 45</div>
<div class="line">                 },</div>
<div class="line">                 &quot;VO&quot;: {}</div>
<div class="line">             }</div>
<div class="line">         ],</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md10"></a>
LOCAL</h2>
<p>And LOCAL, byte offsets into the raw data files emitted by a PCS run: </p><div class="fragment"><div class="line">   &quot;LOCAL&quot;: [</div>
<div class="line">        {</div>
<div class="line">            &quot;VI_OFFSETS&quot;: {</div>
<div class="line">                &quot;AI16&quot;: 0,</div>
<div class="line">                &quot;DI32&quot;: 256,</div>
<div class="line">                &quot;SP32&quot;: 260</div>
<div class="line">            },</div>
<div class="line">            &quot;VO_OFFSETS&quot;: {</div>
<div class="line">                &quot;AO16&quot;: 0,</div>
<div class="line">                &quot;DO32&quot;: 64</div>
<div class="line">            },</div>
<div class="line">            &quot;VX_LEN&quot;: {</div>
<div class="line">                &quot;VI&quot;: 320,</div>
<div class="line">                &quot;VO&quot;: 68</div>
<div class="line">            }</div>
<div class="line">        },</div>
<div class="line">        {</div>
<div class="line">            &quot;VI_OFFSETS&quot;: {</div>
<div class="line">                &quot;AI16&quot;: 0,</div>
<div class="line">                &quot;DI32&quot;: 256,</div>
<div class="line">                &quot;SP32&quot;: 260</div>
<div class="line">            },</div>
<div class="line">            &quot;VO_OFFSETS&quot;: {</div>
<div class="line">                &quot;AO16&quot;: 0,</div>
<div class="line">                &quot;DO32&quot;: 64</div>
<div class="line">            },</div>
<div class="line">            &quot;VX_LEN&quot;: {</div>
<div class="line">                &quot;VI&quot;: 320,</div>
<div class="line">                &quot;VO&quot;: 68</div>
<div class="line">            }</div>
<div class="line">        },</div>
<div class="line">        {</div>
<div class="line">            &quot;VI_OFFSETS&quot;: {</div>
<div class="line">                &quot;AI16&quot;: 0,</div>
<div class="line">                &quot;DI32&quot;: 256,</div>
<div class="line">                &quot;SP32&quot;: 260</div>
<div class="line">            },</div>
<div class="line">            &quot;VO_OFFSETS&quot;: {</div>
<div class="line">                &quot;AO16&quot;: 0,</div>
<div class="line">                &quot;DO32&quot;: 64</div>
<div class="line">            },</div>
<div class="line">            &quot;VX_LEN&quot;: {</div>
<div class="line">                &quot;VI&quot;: 320,</div>
<div class="line">                &quot;VO&quot;: 68</div>
<div class="line">            }</div>
<div class="line">        },</div>
<div class="line">        {</div>
<div class="line">            &quot;VI_OFFSETS&quot;: {</div>
<div class="line">                &quot;AI32&quot;: 0,</div>
<div class="line">                &quot;SP32&quot;: 192</div>
<div class="line">            },</div>
<div class="line">            &quot;VO_OFFSETS&quot;: {},</div>
<div class="line">            &quot;VX_LEN&quot;: {</div>
<div class="line">                &quot;VI&quot;: 256,</div>
<div class="line">                &quot;VO&quot;: 0</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    ]</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md11"></a>
More to come..</h1>
<p>comments please to <a href="#" onclick="location.href='mai'+'lto:'+'pet'+'er'+'.mi'+'ln'+'e@d'+'-t'+'acq'+'.c'+'om'; return false;">peter<span style="display: none;">.nosp@m.</span>.mil<span style="display: none;">.nosp@m.</span>ne@d-<span style="display: none;">.nosp@m.</span>tacq<span style="display: none;">.nosp@m.</span>.com</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.18
</small></address>
</body>
</html>
