<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AFHBA404: NEWS32 : example 4 x ACQ2106+ACQ435, located N,E,W,S at distance.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AFHBA404
   </div>
   <div id="projectbrief">AFHBA404 connects ACQ2106 to PCI-Express</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.18 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">NEWS32 : example 4 x ACQ2106+ACQ435, located N,E,W,S at distance. </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ul>
<li>units each have a free running clock</li>
<li>start continuous capture on AFHBA broadcast TRG</li>
<li>instrument system by outputting TRG on FP GPIO at end of each cycle.</li>
<li>./ACQPROC/configs/news32.json defines the whole system</li>
<li>./ACQPROC/configs/n32.json defines a single-box minimal system</li>
</ul>
<h1><a class="anchor" id="autotoc_md32"></a>
Example Operation with single box:</h1>
<h2><a class="anchor" id="autotoc_md33"></a>
First, run a control script to configure the box - we like 49999Hz because that's the highest setting for HR_512 mode : lowest latency with highest SNR</h2>
<div class="fragment"><div class="line">./scripts/acqproc_config_freerunning_acq435 --acq435SR 49999 acq2106_130</div>
</div><!-- fragment --><ul>
<li>View result in cs-studio: <img src="DOC/CONFIG.png" alt="GitHub" class="inline"/></li>
</ul>
<h2><a class="anchor" id="autotoc_md34"></a>
Now run the embedded control program</h2>
<div class="fragment"><div class="line">VERBOSE=0 RTPRIO=10 NTRIGGERS=1 HW=1 ./ACQPROC/acqproc_broadcast_trigger ./ACQPROC/configs/n32.json 1000000</div>
</div><!-- fragment --><ul>
<li>View result in cs-studio ... now the system is capturing data.</li>
</ul>
<p><img src="DOC/RUN.png" alt="Github" class="inline"/></p>
<ul>
<li>MGT page tracks data on the fiber, matching the stream data showing data to local DRAM</li>
</ul>
<p><img src="DOC/MGT.png" alt="Github" class="inline"/></p>
<ul>
<li>View Live result in scope: C3 is the output trigger. C2 is the actual signal, zero crossing detected at -820 us</li>
<li>GD=39 * 20us = 780 us</li>
<li>Overhead of teeing up and broadcasting the marker is O(20us)</li>
<li>=&gt; overhead of the HOST SW &lt; 20usec, latency of the input : 800us</li>
<li>Assume 4 x free running boxes, all samples collected at the same time: skew = +/-1 sample (20usec)</li>
<li>Worst case latency: 800+20 = 830usec.</li>
</ul>
<p><img src="DOC/RESULT.png" alt="Github" class="inline"/></p>
<ul>
<li>Measuring the broadcast trigger overhead ... scope shows NTRIGGERS=3 group of 3 at 20usec spacing.. <div class="fragment"><div class="line">VERBOSE=0 RTPRIO=10 NTRIGGERS=3 HW=1 ./acqproc_broadcast_trigger configs/n32.json 1000000</div>
</div><!-- fragment --></li>
</ul>
<p><img src="DOC/TRIGGEROVERHEAD.png" alt="Github" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md35"></a>
Operation with 4 boxes</h1>
<h2><a class="anchor" id="autotoc_md36"></a>
Check config with no hardware</h2>
<div class="fragment"><div class="line">RTPRIO=10 NTRIGGERS=1 HW=0 ./ACQPROC/acqproc_broadcast_trigger configs/news32.json 1000000</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md37"></a>
Run with hardware</h2>
<div class="fragment"><div class="line">./scripts/acqproc_config_freerunning_acq435 --acq435SR 49999 @ACQPROC/configs/news32.json</div>
<div class="line">RTPRIO=10 NTRIGGERS=1 HW=1 ./acqproc_broadcast_trigger configs/news32.json 1000000</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md38"></a>
Run with two hosts and check skew</h2>
<ul>
<li>connect analog signal to scope #1</li>
<li>connect analog signal to CH01 on each of two boxes, n, s</li>
<li>connect GPIO output from each of the two boxes to scope channels #2 and #3, trigger on one of them <div class="fragment"><div class="line">SITECLIENT_TRACE=1 ./scripts/acqproc_config_freerunning_acq435 --acq435SR 49999 @ACQPROC/configs/ns32.json</div>
<div class="line">THCHAN0=0 THCHAN1=32 VERBOSE=0 RTPRIO=10 NTRIGGERS=1 HW=1 ./ACQPROC/acqproc_broadcast_trigger ACQPROC/configs/ns32.json 0</div>
</div><!-- fragment --></li>
<li><a href="DOC/twouuts-2020-06-09_17.45.54.mkv" title="Two Box movie"><img src="DOC/TWOUUTS.png" alt="two uut movie" class="inline"/></a></li>
<li>THCHAN0=0 THCHAN1=32 :: On alternate cycles, use AI[0] then AI[32] as the source of data eg uutN.CH01, uutS.CH01</li>
<li>Cursor (a) shows the zero crossing detected by software, with output pulse at (b), +800usec</li>
<li>SR=50kHz, 20usec, and with 40 sample group delay, it's 800usec as expected.</li>
<li>The previous output pulse is on the far left of the screen, and is subject to about 20usec wander, this is the "skew" between uutN and uutS, which are running on the same clock.</li>
<li>If they were to run on the same clock, eg with White Rabbit, there'd be no wander.</li>
</ul>
<h2><a class="anchor" id="autotoc_md39"></a>
Stopping</h2>
<ul>
<li>Simply abort the Control Program</li>
<li>Stop all the UUTS <div class="fragment"><div class="line">./scripts/acqproc_config_freerunning_acq435 --stop=1 @ACQPROC/configs/news32.json</div>
</div><!-- fragment --></li>
</ul>
<h1><a class="anchor" id="autotoc_md40"></a>
Operation with 4 boxes and MEAN of last N</h1>
<h2><a class="anchor" id="autotoc_md41"></a>
Run with hardware</h2>
<div class="fragment"><div class="line">./scripts/acqproc_config_freerunning_acq435 --acq435SR 100000 @ACQPROC/configs/news32.json</div>
<div class="line">RTPRIO=10 NTRIGGERS=1 HW=N ./acqproc_broadcast_trigger configs/news32.json 1000000</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md42"></a>
Example: SR=100kHz, HW=1, signal=5kHz</h3>
<p><img src="https://user-images.githubusercontent.com/3041171/90416002-cf493e00-e0a9-11ea-95b4-557c90b43938.png" alt="SR=100kHz, HW=1, signal=5kHz" class="inline"/> </p>
<h3><a class="anchor" id="autotoc_md43"></a>
Example: SR=100kHz, HW=10, signal=5kHz</h3>
<p><img src="https://user-images.githubusercontent.com/3041171/90416391-4ed70d00-e0aa-11ea-9382-ab5401758603.png" alt="SR=100kHz,Signal=5kHz,HW=10" class="inline"/> </p>
<h3><a class="anchor" id="autotoc_md44"></a>
Example: SR=100kHz, HW=20, signal=5kHz</h3>
<p>In this case, we're averaging over a full cycle, so no threshold crossing, <em><b>NO OUTPUT</b></em> <img src="https://user-images.githubusercontent.com/3041171/90416497-71692600-e0aa-11ea-8dde-7748e7fb602a.png" alt="SR=100kHz,Signal=5kHz,HW=20" class="inline"/> </p>
<h3><a class="anchor" id="autotoc_md45"></a>
Example: SR=100kHz, HW=20, signal=2kHz</h3>
<p><em><b>OUTPUT restored</b></em> <img src="https://user-images.githubusercontent.com/3041171/90416651-a8d7d280-e0aa-11ea-8459-7c3318fc4b75.png" alt="SR=100kHz,Signal=2kHz,HW=20" class="inline"/></p>
<p>Please try it. Send questions to peter dot <a href="#" onclick="location.href='mai'+'lto:'+'mil'+'ne'+'@d-'+'ta'+'cq.'+'co'+'m'; return false;">milne<span style="display: none;">.nosp@m.</span>@d-t<span style="display: none;">.nosp@m.</span>acq.c<span style="display: none;">.nosp@m.</span>om</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.18
</small></address>
</body>
</html>
